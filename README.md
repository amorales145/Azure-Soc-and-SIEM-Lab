
![SOCSIEM](https://github.com/user-attachments/assets/6d8a8f03-652a-429a-baae-95ed90809d0d)


In this project, I created a mini SOC in Azure to monitor and analyze security events. Logs from various resources were ingested into a Log Analytics Workspace, which was integrated with Microsoft Sentinel SIEM to generate attack maps, trigger alerts, and create incidents. 

    • SecurityEvent: Windows Event Logs
    • Syslog: Linux Event Logs
    • SecurityAlerts: Alerts triggered by Log Analytics
    • SecurityIncidents: Incidents generated by Microsoft Sentinel
    • AzureNetworkAnalytics_CL: Malicious network traffic detected in the honeypot

You can use this step by step document to create your own similar setup/ use case.  Be mindful that certain settings might differ a bit based on updates that Azure may have completed since the creation of this document. This is a somewhat simple overview of a SOC SIEM and you should have some knowledge of Azure and the terminology used.
Overall I had to research a lot of information as some of the details I found from different sources were not exact to make this use case possible. One main difference in this document is logging data with (AMA), known as Azure monitor agent, the previous log analytics agent is in deprecation.  I have attached a document named ( AMA_Config_LOGAnalyticsAgentDeprecated ) to get more detailed information on this once we get to that point. Please follow along below. I will be adding a youtube video with detailed information on this as well. Stay tuned for that! Thank you!

1.    Create Resource Group
2.    Create VM Win10 pro v.22h2 x64 gen2
- standard_e2s_v3 – 2vcpus 12gig mem
- create new virtual network (your vnet)
3.    create linux vm Ubuntu server 22.04 lts x64 gen2
- standard_e2s_v3- 2vcpus 16gig mem
- make sure all your VM's are in the same vnet
4.	NSG’s (Network Security Groups) (This is essentially a firewall)
- go to windows vm NSG
- delete RDP rule
-Add new inbound rule – source Any – port range * - Destination Any – Destination port range *
5.	Go to linux VM NSG and do the same.
- Delete SSH Rule
6.	RDP into win vm and disable firewall
7.	Create SQL database – search for SQL server eval – 2019 evaluation
- run exe and download media
- select iso – download
- open folder – right click on ISO and mount
- run setup.exe
- click installation – new swl server stand alone
- dont use update option
- check DB engine services – next – default instance – next
- next on server config
- select Mixed Mode SQL Server Auth
- use same PW
- add current user – next – install
8.	Download SSMS (This is to view sql server with UI. Could be done through powershell but this 	is just for lab purposes)

- open event viewer – co changes yet just keep open
- Link for SQL Audit Events 

https://learn.microsoft.com/en-us/sql/relational-databases/security/auditing/write-sql-server-audit-events-to-the-security-log?view=sql-server-ver16

- Open regedit
- sql data to audit events in registry (this will allow SQL server to send logs to event viewer.
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\EventLog\Security

- right click on “security” folder hive in registry – permissions – add – network service
- Run the below command in command prompt.
auditpol /set /subcategory:"application generated" /success:enable /failure:enable
- go to sql server management studio
- under authentication select SQLSERVER AUTHENTICATION
- login with you credentials (this will be the first login so you set the creds now)
- check trust server cert

- right click on sql server – properties – security -LOG auditing – Select both failed and successful logins – ok – disconnect – reconnect. ( We are generating logs so type the password wrong a few times and then login successfully)
- go to event viewer – windows logs – application (Note failed events)
9.	Go to linux VM in Azure and get the IP address. Ping the IP from your windows machine.
- SSH into linux box from command prompt ( SSH “yourusername”@”yourIP” - Exit
(Recap: Both VM’s have been setup – SQL DB Setup _ NSG’s Vulnerable”

10.	Create Attack VM
- create new resource group (AttackerVM)
- Win 10 pro, V22H2 – 64 Gen 2
- Use same UN and PW so it’s easy to remember
- Networking – Make sure to use new VNET
- Put in different location
- Connect to VM – grab other win VM IP
- Open RDC – Fail some logins from the attacker VM into the non attacker machine and this will generate failed login logs
- Open Powershell and fail logins into Linux VM via SSH
- Login to normal non attacker VM and confirm login attempts in event viewer
- On your local machine (Non VM) SSH into linux box.
- Go to /var/log
- run command without quotes “ cat auth.log | grep password
( Note: this will show all login attempts )

11.	Create Log Analytics Workspace in MS Sentinel
- Go to Log Analytics workspace – create new – Put in your resource group
- Name it something you can remember like LAW-”yourresourcegroupname” (No quotes!)
- create
- go to MS sentinel – create – select new LAW (Log analytics workspace) - “yourname” - scroll down to watchlist
- Click new – Name must be geoip ( NOTE: This will NOT work if name is not exactly geoip)
- source type = local file
- file type = CSV
- number of lines = 0
- upload file geoip.csv (This is a geographical network correlation file that will populate attacker locations on a map )
- search key = network
- review and create / create (This can take anythere from 10 minutes to a half hour. The file iss about 55k so it will take some time)
- go to log analytics workspaces – click on LAW”yourname”
- logs – new query – type GetWatchlist(“geoip”)
- type | count under GetWatchlist(“geoip”)
- you will see total count as file starts to load in real time. The total should be around 54803

12.	Enable Microsoft Defender for Cloud (NOTE: this is where you will need to reference the  AMA_Config_LOGAnalyticsAgentDeprecated file as I stated in the beginning of this document.
- search for ms defender for cloud
- go to environment settings – go to LAW – your resourcegroup name
- defender plans – turn on servers – turn on sql servers – on machines
- go to data collection – select all events
- back to your azure subscription – ENV settings
- scroll to cloud workload protection (CWP)
- servers on – Databases on – storage on – Keyvault on
- On server go to settings link – (NOTE!: This is where the AMA_Config_LOGAnalyticsAgentDeprecated document is crucial as the initial setup has changed a bit. Just follow that document and watch the Video.) (I learned this as I was setting this up initially do to microsoft making some design changes)
- Go back to MS defender for cloud - environment settings - Subscription - Continuous export - click on log analytics work space tab - everything must be checked and
  select you rresource group as well as target workspace. save
- Go to Log analytics workspaces – select WS – Agents – Data collection rules – select rule – data sources – win event logs – click custom (NOTE: Must use XPATH FILE) copy and paste
- Go to log analytics workspace – logs (NOTE: The language in this system is know as KQL. You can do more research on this to get familiar)
- type syslog (Note: this will produce logs for linux)
- type securityevent (for windows logs)
- type AureNetworkAnalytics_CL ( for Network security groups)
NOTE: the network security group logs will take some time to populate as this is specific to malicious network traffic.
- Go to Entra ID – Diagnostic settings – click diagnostic setting
- add Auditlogs and sign in logs
- check both – git it a name
- check destination details – send to log analytics workspace – save
- got to log analytics workspace – logs – type “ SigninLogs” NO QUOTES.
- got to entra id and create new user – add role – global admin
- login to MS Azure web portal and fail a few logins to generate Entra ID level logs
- go to log analytics workspace – logs -  type “ AuditLogs “

13.	Create Logs on a Subscription Level
- Go to Monitor – activity log -click export activity logs tab – add diagnostic settings – select all log categories (NOTE: check off send to log analytics workspace)
- name it something like DS-Azure-Activity
(NOTE: This will send all subscription level events to LAWS (Log analytics workspace)
- Go to LAWS – logs – type “ AzureActivity
- got to resource groups and create a resource group and delete it
(NOTE: Again we are just trying to create some activity to capture on a subscription level)
(It will also take some time to capture this data)

14.	Resource Level Logs

- create storage account – go to diagnostic settings – under monitoring – click on BLOB – select Audit check box – Give it a name – select send to LAWS – SAVE!
- Go to storage accounts – containers – create test container
- got to keyvaults – create – name it test – vault access policy – select user on bottom – next – review and create
- go back to key vault – generate secret
- name it test secret – value test
- go into secret – click show secret (NOTE: this will trigger logs)
- go to LAWS – logs – type “ StorageBlogLogs” NO QUOTES
- Type “ AzureDisagnostics “ NO QUOTES

15.	MS Sentinel Workbooks (NOTE: Workbooksare directly correlated to Maps. Malicious traffic, auth failures, bruteforce attempts, etc etc…)
- Go to MS Sentinel – workbooks
- Add workbook – edit on top left – 3 dots on right
- Remove whatever is there
- Add – Add query – advanced editor. (NOTE: You will need to add the data contained in the .json files for each query.  Just repeat the process for all 4.  These are the file names.
linuxssh.json – mssql.json – nsgmaliciousactivity.json – windowsrdp.json
(NOTE: All workbooks must be added in the same way.  The steps are all the same)

16.	MS Sentinel Incidents
- Go to Microsoft sentinel – Analytics – import – select sentinel- analytics-rules.json file
(NOTE: Within MS Sentinel’s SIEM you can manage all security incidents with detailed information and functionality)
This is a crucial step as this will populate all of the Rules that are specific to incidents that will be logged.

There are 3 main locations for threat analysis within MS sentinel.
1. Analytics - This is where all the rules have been applied from the Sentinel.json file I have provided.
   ![Analytics](https://github.com/user-attachments/assets/f4cccb93-3080-4837-8245-3e9bf4ddd5a0)



2. Workbooks - This is directly related to the geoip.json file and is a good map of threat detection from a global perspective.
   ![workbooks](https://github.com/user-attachments/assets/c9afe5b7-c753-433d-aed7-5bd51c90c216)
   ![linuxsshworkbookGEOIPview](https://github.com/user-attachments/assets/a229c70f-97b1-405a-a37f-0935bbd84fd0)



3. Incidents - This is where we get detailed threat related information.
   ![incidents](https://github.com/user-attachments/assets/172b2779-f982-4fd8-9ea1-82548699bb91)




Thank you for reading my work!  I hope this detailed document is useful to you!
